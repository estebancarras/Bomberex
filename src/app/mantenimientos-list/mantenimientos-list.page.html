<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Lista de Mantenimientos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Barra de búsqueda -->
  <ion-toolbar class="search-toolbar">
    <ion-searchbar 
      placeholder="Buscar mantenimientos..." 
      [(ngModel)]="searchTerm"
      (ionInput)="handleSearch($event)"
      animated="true">
    </ion-searchbar>
  </ion-toolbar>

  <!-- Barra de acciones flotante cuando hay selección -->
  <div class="floating-actions" *ngIf="selection.size > 0">
    <ion-chip color="primary">
      <ion-label>{{ selection.size }} seleccionado(s)</ion-label>
    </ion-chip>
    <ion-button fill="clear" size="small" (click)="editarSeleccionado()" [disabled]="selection.size !== 1">
      <ion-icon slot="icon-only" name="create-outline"></ion-icon>
    </ion-button>
    <ion-button fill="clear" size="small" color="danger" (click)="borrarSeleccionados()">
      <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
    </ion-button>
    <ion-button fill="clear" size="small" color="tertiary" (click)="descargarSeleccionados()">
      <ion-icon slot="icon-only" name="download-outline"></ion-icon>
    </ion-button>
    <ion-button fill="clear" size="small" (click)="selection.clear(); updateActionButtons()">
      <ion-icon slot="icon-only" name="close-outline"></ion-icon>
    </ion-button>
  </div>

  <!-- Filtros rápidos para móvil -->
  <ion-segment [(ngModel)]="activeFilter" (ionChange)="applyFilters()" class="filter-segment">
    <ion-segment-button value="todos">
      <ion-label>Todos</ion-label>
    </ion-segment-button>
    <ion-segment-button value="pendiente">
      <ion-label>Pendientes</ion-label>
    </ion-segment-button>
    <ion-segment-button value="progreso">
      <ion-label>En Progreso</ion-label>
    </ion-segment-button>
    <ion-segment-button value="completado">
      <ion-label>Completados</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Botón para filtros avanzados -->
  <ion-item lines="none" class="filter-button">
    <ion-button fill="clear" (click)="openFilterModal()">
      <ion-icon slot="start" name="filter-outline"></ion-icon>
      Filtros avanzados
    </ion-button>
    <ion-chip *ngIf="activeFiltersCount > 0" color="secondary">
      <ion-label>{{ activeFiltersCount }}</ion-label>
    </ion-chip>
  </ion-item>

  <!-- Vista lista para móvil/tablet -->
  <div class="mobile-view" *ngIf="!isDesktop">
    <ion-list>
      <ion-item-sliding *ngFor="let mantenimiento of filteredData" class="maintenance-item">
        <ion-item [button]="true" (click)="toggleSelection(mantenimiento.id)" [class.selected]="isSelected(mantenimiento.id)">
          <ion-checkbox slot="start" [checked]="isSelected(mantenimiento.id)" (click)="$event.stopPropagation()"></ion-checkbox>
          
          <ion-label>
            <h2><strong>{{ mantenimiento.patente }}</strong></h2>
            <p>{{ mantenimiento.descripcion }}</p>
            <ion-grid class="item-details">
              <ion-row>
                <ion-col size="6">
                  <ion-chip [color]="getPrioridadColor(mantenimiento.prioridad)" class="priority-chip">
                    <ion-label>{{ mantenimiento.prioridad | titlecase }}</ion-label>
                  </ion-chip>
                </ion-col>
                <ion-col size="6" class="ion-text-end">
                  <ion-chip [color]="getEstadoColor(mantenimiento.estado)" class="status-chip">
                    <ion-label>{{ mantenimiento.estado }}</ion-label>
                  </ion-chip>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="12">
                  <ion-note>
                    <ion-icon name="calendar-outline"></ion-icon>
                    {{ formatDateRange(mantenimiento.Tiempomanteni) }}
                  </ion-note>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-label>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option color="primary" (click)="editarMantenimiento(mantenimiento)">
            <ion-icon slot="icon-only" name="create-outline"></ion-icon>
          </ion-item-option>
          <ion-item-option color="danger" (click)="borrarMantenimiento(mantenimiento)">
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-item-option>
          <ion-item-option color="tertiary" (click)="descargarPDF(mantenimiento)">
            <ion-icon slot="icon-only" name="download-outline"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

    <!-- Estado vacío -->
    <div class="empty-state" *ngIf="filteredData.length === 0">
      <ion-icon name="clipboard-outline"></ion-icon>
      <h3>No hay mantenimientos</h3>
      <p>No se encontraron mantenimientos con los filtros aplicados</p>
      <ion-button fill="clear" (click)="resetFilters()">
        Limpiar filtros
      </ion-button>
    </div>
  </div>

  <!-- Vista tabla para desktop -->
  <div class="desktop-view" *ngIf="isDesktop">
    <ion-grid>
      <ion-row>
        <!-- Panel de filtros lateral -->
        <ion-col size="3" class="filters-panel">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Filtros</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item>
                  <ion-label>Estado</ion-label>
                  <ion-select [(ngModel)]="filters.estado" (ionChange)="applyFilters()" interface="popover">
                    <ion-select-option value="">Todos</ion-select-option>
                    <ion-select-option value="Pendiente">Pendiente</ion-select-option>
                    <ion-select-option value="En progreso">En progreso</ion-select-option>
                    <ion-select-option value="Completado">Completado</ion-select-option>
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-label>Prioridad</ion-label>
                  <ion-select [(ngModel)]="filters.prioridad" (ionChange)="applyFilters()" interface="popover">
                    <ion-select-option value="">Todas</ion-select-option>
                    <ion-select-option value="alta">Alta</ion-select-option>
                    <ion-select-option value="media">Media</ion-select-option>
                    <ion-select-option value="baja">Baja</ion-select-option>
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-label>Categoría</ion-label>
                  <ion-select [(ngModel)]="filters.categoria" (ionChange)="applyFilters()" interface="popover">
                    <ion-select-option value="">Todas</ion-select-option>
                    <ion-select-option value="preventivo">Preventivo</ion-select-option>
                    <ion-select-option value="correctivo">Correctivo</ion-select-option>
                    <ion-select-option value="emergencia">Emergencia</ion-select-option>
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-label>Taller</ion-label>
                  <ion-input [(ngModel)]="filters.taller" (ionInput)="applyFilters()" placeholder="Filtrar por taller"></ion-input>
                </ion-item>
              </ion-list>

              <ion-button expand="block" fill="clear" (click)="resetFilters()" class="ion-margin-top">
                Limpiar filtros
              </ion-button>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Tabla de datos -->
        <ion-col size="9">
          <ion-card class="table-card">
            <ion-card-content>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>
                      <ion-checkbox 
                        [checked]="isAllSelected()" 
                        [indeterminate]="isIndeterminate()"
                        (ionChange)="masterToggle()">
                      </ion-checkbox>
                    </th>
                    <th (click)="sortData('patente')">
                      Patente
                      <ion-icon name="arrow-down" *ngIf="sortField === 'patente'"></ion-icon>
                    </th>
                    <th (click)="sortData('Tiempomanteni')">
                      Tiempo Mantenimiento
                      <ion-icon name="arrow-down" *ngIf="sortField === 'Tiempomanteni'"></ion-icon>
                    </th>
                    <th (click)="sortData('categoria')">
                      Categoría
                      <ion-icon name="arrow-down" *ngIf="sortField === 'categoria'"></ion-icon>
                    </th>
                    <th (click)="sortData('prioridad')">
                      Prioridad
                      <ion-icon name="arrow-down" *ngIf="sortField === 'prioridad'"></ion-icon>
                    </th>
                    <th (click)="sortData('estado')">
                      Estado
                      <ion-icon name="arrow-down" *ngIf="sortField === 'estado'"></ion-icon>
                    </th>
                    <th>Taller</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let mantenimiento of paginatedData" [class.selected]="isSelected(mantenimiento.id)">
                    <td>
                      <ion-checkbox 
                        [checked]="isSelected(mantenimiento.id)"
                        (ionChange)="toggleSelection(mantenimiento.id)">
                      </ion-checkbox>
                    </td>
                    <td>{{ mantenimiento.patente }}</td>
                    <td>{{ formatDateRange(mantenimiento.Tiempomanteni) }}</td>
                    <td>{{ mantenimiento.categoria | titlecase }}</td>
                    <td>
                      <ion-chip [color]="getPrioridadColor(mantenimiento.prioridad)" class="priority-chip">
                        <ion-label>{{ mantenimiento.prioridad | titlecase }}</ion-label>
                      </ion-chip>
                    </td>
                    <td>
                      <ion-chip [color]="getEstadoColor(mantenimiento.estado)" class="status-chip">
                        <ion-label>{{ mantenimiento.estado }}</ion-label>
                      </ion-chip>
                    </td>
                    <td>{{ mantenimiento.tallerResponsable || '-' }}</td>
                    <td class="description-cell">{{ mantenimiento.descripcion }}</td>
                    <td>
                      <ion-button fill="clear" size="small" (click)="editarMantenimiento(mantenimiento)">
                        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                      </ion-button>
                      <ion-button fill="clear" size="small" color="danger" (click)="borrarMantenimiento(mantenimiento)">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                      </ion-button>
                      <ion-button fill="clear" size="small" color="tertiary" (click)="descargarPDF(mantenimiento)">
                        <ion-icon slot="icon-only" name="download-outline"></ion-icon>
                      </ion-button>
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Paginación -->
              <div class="pagination">
                <ion-button fill="clear" [disabled]="currentPage === 1" (click)="previousPage()">
                  <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
                </ion-button>
                <span>Página {{ currentPage }} de {{ totalPages }}</span>
                <ion-button fill="clear" [disabled]="currentPage === totalPages" (click)="nextPage()">
                  <ion-icon slot="icon-only" name="chevron-forward"></ion-icon>
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando mantenimientos...</p>
  </div>
</ion-content>
